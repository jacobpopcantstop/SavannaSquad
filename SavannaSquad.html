<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>9-1-1 Savanna Squad: Platinum Edition</title>
    
    <!-- React & DOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .animate-float { animation: float 4s ease-in-out infinite; }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ROBUST ICON SYSTEM ---
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2.5" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
                dangerouslySetInnerHTML={{ __html: path }}
            />
        );

        const ICONS = {
            Heart: '<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>',
            Shield: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>',
            Zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
            Hourglass: '<path d="M5 22h14"/><path d="M5 2h14"/><path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22"/><path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2"/>',
            Activity: '<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>',
            Star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
            Volume2: '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>',
            StopCircle: '<circle cx="12" cy="12" r="10"/><rect x="9" y="9" width="6" height="6"/>',
            Settings: '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>',
            RefreshCw: '<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>',
            Brain: '<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/>',
            AlertTriangle: '<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>',
            Skull: '<circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/>',
            Trophy: '<path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>',
            ArrowRight: '<path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>',
            Mail: '<rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>',
            Award: '<circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>',
            Dice: '<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M16 8h.01"/><path d="M8 8h.01"/><path d="M8 16h.01"/><path d="M16 16h.01"/><path d="M12 12h.01"/>',
            Flame: '<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>'
        };

        // --- RANDOM EVENTS DATA ---
        const RANDOM_EVENTS = [
            { id: 'traffic', text: "Traffic on the way to work was awful! You barely made roll call.", effect: { pat: -1 }, type: 'bad' },
            { id: 'rain', text: "A sudden rainstorm soaked your uniform while you were outside.", effect: { reg: -1 }, type: 'bad' },
            { id: 'siren', text: "Loud siren test! It hurts your ears and makes you jump.", effect: { reg: -1 }, type: 'bad' },
            { id: 'cookies', text: "A grateful citizen dropped off cookies for the station!", effect: { emp: 1 }, type: 'good' },
            { id: 'clean', text: "The station is surprisingly clean today. It feels peaceful.", effect: { reg: 1 }, type: 'good' },
            { id: 'praise', text: "Chief Alonzo sent a note praising the team's response times.", effect: { prof: 1 }, type: 'good' },
            { id: 'stuck', text: "Your locker door got stuck. It's really frustrating.", effect: { pat: -1 }, type: 'bad' },
            { id: 'joke', text: "Chimney told a really good joke in the hallway.", effect: { emp: 1 }, type: 'good' }
        ];

        // --- TTS Helper ---
        const useTextToSpeech = () => {
            const [isSpeaking, setIsSpeaking] = useState(false);
            const synth = window.speechSynthesis;

            const speak = (text) => {
                if (synth.speaking) synth.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.onend = () => setIsSpeaking(false);
                setIsSpeaking(true);
                synth.speak(utterance);
            };

            const stop = () => {
                synth.cancel();
                setIsSpeaking(false);
            };

            useEffect(() => () => synth.cancel(), []);
            return { speak, stop, isSpeaking };
        };

        // --- Character Component with Props ---
        const SavannaAvatar = ({ type, prop }) => {
            const colors = {
                buck: '#FCD34D', bobby: '#9CA3AF', athena: '#F59E0B',
                hen: '#FDE047', eddie: '#6B7280', chimney: '#D97706', maddie: '#E5E7EB'
            };
            const baseColor = colors[type] || '#9CA3AF';

            const renderProp = () => {
                if (!prop) return null;
                switch (prop) {
                    case 'flag': return <g transform="translate(140, 100) rotate(-10)"><line x1="0" y1="0" x2="0" y2="80" stroke="#FFF" strokeWidth="4"/><rect x="0" y="0" width="40" height="30" fill="#EF4444"/></g>;
                    case 'medal': return <g transform="translate(100, 160)"><circle r="15" fill="#F59E0B" stroke="#B45309" strokeWidth="2"/><path d="M-10 -30 L0 0 L10 -30" fill="none" stroke="#3B82F6" strokeWidth="5"/></g>;
                    case 'clipboard': return <rect x="20" y="100" width="40" height="50" fill="#92400E" rx="2" transform="rotate(-10)"/>;
                    case 'party_hat': return <polygon points="70,10 130,10 100,-40" fill="#EC4899" stroke="#DB2777" strokeWidth="3"/>;
                    case 'fire': return <path d="M140 140 Q 150 100 180 120 Q 160 160 140 140" fill="#EF4444" stroke="#B91C1C" />;
                    default: return null;
                }
            };

            const renderChar = () => {
                switch(type) {
                    case 'buck': return <g><circle cx="100" cy="100" r="90" fill="#B45309"/><circle cx="100" cy="100" r="60" fill={baseColor}/><circle cx="50" cy="60" r="15" fill={baseColor}/><circle cx="150" cy="60" r="15" fill={baseColor}/><ellipse cx="100" cy="120" rx="25" ry="20" fill="#FFF8DC"/><path d="M90 110 L110 110 L100 125 Z" fill="#000"/><circle cx="80" cy="90" r="6" fill="white"/><circle cx="80" cy="90" r="3" fill="black"/><circle cx="120" cy="90" r="6" fill="white"/><circle cx="120" cy="90" r="3" fill="black"/><path d="M60 45 L140 45 C 150 45, 150 35, 140 35 L60 35 C 50 35, 50 45, 60 45" fill="#EF4444"/><rect x="90" y="30" width="20" height="10" fill="#FCD34D"/></g>;
                    case 'bobby': return <g><path d="M20 60 Q 0 100 30 140 L 60 100 Z" fill={baseColor}/><path d="M180 60 Q 200 100 170 140 L 140 100 Z" fill={baseColor}/><circle cx="100" cy="90" r="60" fill={baseColor}/><path d="M90 130 Q 100 200 130 180" fill="none" stroke={baseColor} strokeWidth="20" strokeLinecap="round"/><circle cx="75" cy="80" r="5" fill="black"/><circle cx="125" cy="80" r="5" fill="black"/><path d="M60 40 L140 40 L130 20 L70 20 Z" fill="#1F2937"/><rect x="60" y="40" width="80" height="5" fill="#000"/></g>;
                    case 'athena': return <g><path d="M50 50 Q 100 20 150 50 L 140 150 Q 100 180 60 150 Z" fill={baseColor}/><circle cx="40" cy="60" r="15" fill={baseColor}/><circle cx="160" cy="60" r="15" fill={baseColor}/><path d="M70 90 Q 80 80 90 90" fill="none" stroke="black" strokeWidth="3"/><path d="M110 90 Q 120 80 130 90" fill="none" stroke="black" strokeWidth="3"/><circle cx="80" cy="95" r="4" fill="black"/><circle cx="120" cy="95" r="4" fill="black"/><path d="M90 120 L110 120 L100 135 Z" fill="black"/><path d="M50 40 L150 40 L140 20 L60 20 Z" fill="#1E3A8A"/><circle cx="100" cy="30" r="5" fill="#FCD34D"/></g>;
                    case 'hen': return <g><rect x="80" y="100" width="40" height="100" fill={baseColor}/><circle cx="90" cy="130" r="5" fill="#B45309" opacity="0.6"/><circle cx="110" cy="160" r="7" fill="#B45309" opacity="0.6"/><ellipse cx="100" cy="80" rx="35" ry="45" fill={baseColor}/><line x1="85" y1="40" x2="85" y2="15" stroke={baseColor} strokeWidth="6" strokeLinecap="round"/><circle cx="85" cy="15" r="5" fill="#B45309"/><line x1="115" y1="40" x2="115" y2="15" stroke={baseColor} strokeWidth="6" strokeLinecap="round"/><circle cx="115" cy="15" r="5" fill="#B45309"/><circle cx="85" cy="75" r="12" fill="none" stroke="black" strokeWidth="2"/><circle cx="115" cy="75" r="12" fill="none" stroke="black" strokeWidth="2"/><line x1="97" y1="75" x2="103" y2="75" stroke="black" strokeWidth="2"/><ellipse cx="100" cy="110" rx="20" ry="15" fill="#FEF3C7"/></g>;
                    case 'eddie': return <g><path d="M60 60 Q 100 40 140 60 L 150 140 Q 100 160 50 140 Z" fill={baseColor}/><path d="M100 80 Q 110 50 100 30 Q 90 50 100 80" fill="#E5E7EB" stroke="#4B5563"/><ellipse cx="50" cy="70" rx="10" ry="15" fill={baseColor}/><ellipse cx="150" cy="70" rx="10" ry="15" fill={baseColor}/><circle cx="80" cy="90" r="4" fill="black"/><circle cx="120" cy="90" r="4" fill="black"/><rect x="95" y="145" width="10" height="15" rx="2" fill="#9CA3AF"/></g>;
                    case 'chimney': return <g><ellipse cx="100" cy="120" rx="30" ry="60" fill={baseColor}/><circle cx="100" cy="70" r="25" fill="#FCD34D" opacity="0.9"/><ellipse cx="90" cy="70" rx="8" ry="12" fill="#78350F"/><ellipse cx="110" cy="70" rx="8" ry="12" fill="#78350F"/><circle cx="90" cy="70" r="3" fill="white"/><circle cx="110" cy="70" r="3" fill="white"/><path d="M70 70 Q 70 40 130 70" fill="none" stroke="#1F2937" strokeWidth="3"/><rect x="65" y="65" width="8" height="15" fill="#1F2937" rx="2"/><circle cx="115" cy="85" r="8" fill="#F472B6" opacity="0.8"/></g>;
                    case 'maddie': return <g><path d="M70 60 L 130 60 L 100 140 Z" fill={baseColor}/><path d="M80 60 Q 60 20 80 10" fill="none" stroke="#4B5563" strokeWidth="3"/><path d="M120 60 Q 140 20 120 10" fill="none" stroke="#4B5563" strokeWidth="3"/><ellipse cx="60" cy="70" rx="15" ry="5" fill={baseColor} transform="rotate(-20 60 70)"/><ellipse cx="140" cy="70" rx="15" ry="5" fill={baseColor} transform="rotate(20 140 70)"/><circle cx="90" cy="90" r="4" fill="black"/><circle cx="110" cy="90" r="4" fill="black"/></g>;
                    default: return null;
                }
            };

            return (
                <svg viewBox="0 0 200 200" className="w-full h-full drop-shadow-2xl filter transition-transform duration-700 hover:scale-105 animate-float">
                    {renderChar()}
                    {renderProp()}
                </svg>
            );
        };

        // --- Game Data (Day 1 - Day 5) ---
        const SCENES = {
            start: {
                id: 'start',
                bg: 'from-slate-900 to-black',
                character: null,
                text: "Welcome to the 118 Savanna Station! You are Ayshe. It's Day 1. The team is wild. Your goal: Make friends and stay cool.",
                speaker: "Narrator",
                choices: [{ text: "Start my shift", nextScene: 'lobby' }]
            },
            // --- DAY 1 ---
            lobby: {
                id: 'lobby',
                bg: 'from-slate-800 to-slate-900',
                character: 'bobby',
                text: "Captain Bobby (The Elephant) is polishing the fire truck. \"Welcome, Ayshe. Ready to join the herd?\"",
                speaker: "Bobby (Elephant)",
                choices: [
                    { text: "\"Hi Captain! The truck looks great.\"", nextScene: 'level1_hub', stats: { prof: 1, emp: 1, pat: 0, reg: 0, assert: 1 }, feedback: "Professional, Kind, & Assertive. Starting with confidence builds rapport." },
                    { text: "\"I'm freaking out about the schedule!\"", nextScene: 'level1_hub', stats: { prof: -1, emp: 0, pat: 0, reg: -1, assert: 0 }, feedback: "Logistical Anxiety. This is an 'Unexpected' first greeting. Take a breath first." },
                    { text: "*Try to climb on his back*", nextScene: 'level1_hub', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, flag: 'rode_bobby', feedback: "Crazy Cuckoo! Unexpected behavior. He is your boss, not a pony. (-3 Professional)" },
                    { text: "\"It smells weird here.\"", nextScene: 'level1_hub', stats: { prof: -1, emp: -2, pat: 0, reg: 0, assert: 0 }, feedback: "Negativity. Complaining first thing sets a bad tone." }
                ]
            },
            level1_hub: {
                id: 'level1_hub',
                bg: 'from-slate-800 to-slate-900',
                character: null,
                text: "CHAPTER 1: The Watering Hole. Who needs a friend?",
                speaker: "Watering Hole",
                choices: [
                    { text: "Buck the Lion (Sad)", nextScene: 'gym_intro', targetChar: 'buck' },
                    { text: "Athena the Lioness (Angry)", nextScene: 'loft_intro', targetChar: 'athena' },
                    { text: "Hen the Giraffe (Busy)", nextScene: 'corner_intro', targetChar: 'hen' },
                    { text: "I'm done here. (Next Chapter)", nextScene: 'level2_transition', isExit: true }
                ]
            },
            gym_intro: {
                id: 'gym_intro',
                bg: 'from-gray-800 to-gray-900',
                character: 'buck',
                text: "Buck is pacing. \"I feel like I lost my roar on that last call.\"",
                speaker: "Buck (Lion)",
                choices: [
                    { text: "\"What happened? I'm listening.\"", nextScene: 'buck_success', stats: { prof: 0, emp: 1, pat: 1, reg: 0, assert: 0 }, feedback: "Patience & Empathy. Listening helps. (+1 Empathetic)" },
                    { text: "*Roar loudly* \"I am the alpha!\"", nextScene: 'buck_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, flag: 'roared_at_buck', feedback: "Crazy Cuckoo! High energy at the wrong time. (+2 Assertive, -3 Professional)" },
                    { text: "\"My paws hurt.\"", nextScene: 'buck_fail', stats: { prof: 0, emp: -2, pat: 0, reg: 0, assert: 0 }, feedback: "Thinking of yourself. Focus on him." },
                    { text: "\"Get over it, lion.\"", nextScene: 'buck_fail', stats: { prof: 0, emp: -3, pat: 0, reg: 0, assert: 1 }, feedback: "Dismissive. That hurts feelings. (+1 Assertive, -3 Empathetic)" }
                ]
            },
            buck_success: { id: 'buck_success', bg: 'from-yellow-900 to-slate-900', character: 'buck', mood: 'happy', text: "\"Thanks. Talking helps.\"", speaker: "Buck", choices: [{ text: "Return", nextScene: 'level1_hub' }] },
            buck_fail: { id: 'buck_fail', bg: 'from-gray-900 to-black', character: 'buck', text: "\"Uh... nevermind.\"", speaker: "Buck", choices: [{ text: "Return", nextScene: 'level1_hub' }] },
            loft_intro: {
                id: 'loft_intro',
                bg: 'from-orange-900 to-slate-900',
                character: 'athena',
                text: "\"That hyena detective ruined my crime scene!\"",
                speaker: "Athena (Lioness)",
                choices: [
                    { text: "*Listen quietly*", nextScene: 'athena_success', stats: { prof: 1, emp: 1, pat: 2, reg: 1, assert: 0 }, feedback: "Waiting & Calm. Good listening skills. (+0 Assertive)" },
                    { text: "\"Stop scratching things!\"", nextScene: 'athena_fail', stats: { prof: -2, emp: -2, pat: 0, reg: -1, assert: 1 }, feedback: "Bossy. Don't correct the Queen. (+1 Assertive, -2 Professional)" },
                    { text: "\"Let's eat him!\"", nextScene: 'athena_success', stats: { prof: -3, emp: 1, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! She likes the loyalty, but eating coworkers is against HR policy. (+2 Assertive, -3 Professional)" },
                    { text: "\"Hyenas are gross.\"", nextScene: 'athena_success', stats: { prof: -1, emp: 1, pat: 0, reg: 0, assert: 0 }, feedback: "Bonding. Shared enemy works, but it's not very professional. (-1 Professional)" }
                ]
            },
            athena_success: { id: 'athena_success', bg: 'from-blue-900 to-slate-900', character: 'athena', text: "\"Exactly. Thanks Ayshe.\"", speaker: "Athena", choices: [{ text: "Return", nextScene: 'level1_hub' }] },
            athena_fail: { id: 'athena_fail', bg: 'from-red-900 to-black', character: 'athena', text: "\"Go away, cub.\"", speaker: "Athena", choices: [{ text: "Return", nextScene: 'level1_hub' }] },
            corner_intro: {
                id: 'corner_intro',
                bg: 'from-indigo-900 to-slate-900',
                character: 'hen',
                text: "Hen is studying hard. \"Anatomy is so hard.\"",
                speaker: "Hen (Giraffe)",
                choices: [
                    { text: "*Offer snack break*", nextScene: 'hen_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 0 }, feedback: "Kindness. Gifts help relationship building. (+1 Empathetic)" },
                    { text: "\"I hate my notes!\"", nextScene: 'hen_fail', stats: { prof: -1, emp: -1, pat: 0, reg: -1, assert: 0 }, feedback: "Complaining. Don't make it about you right now." },
                    { text: "\"Can you see the future?\"", nextScene: 'hen_fail', stats: { prof: -2, emp: 0, pat: 0, reg: 0, assert: 0 }, feedback: "Crazy Cuckoo! Weird question." },
                    { text: "*Wait 5 minutes*", nextScene: 'hen_success', stats: { prof: 1, emp: 1, pat: 3, reg: 1, assert: 0 }, flag: 'waited_for_hen', feedback: "High Patience! Great strategy." }
                ]
            },
            hen_success: { id: 'hen_success', bg: 'from-indigo-900 to-slate-900', character: 'hen', text: "\"You're sweet. Thanks.\"", speaker: "Hen", choices: [{ text: "Return", nextScene: 'level1_hub' }] },
            hen_fail: { id: 'hen_fail', bg: 'from-slate-800 to-black', character: 'hen', text: "\"I need to focus.\"", speaker: "Hen", choices: [{ text: "Return", nextScene: 'level1_hub' }] },

            // Level 2
            level2_transition: { id: 'level2_transition', bg: 'from-red-900 to-slate-900', character: null, text: "ALARM! To the truck! Chapter 2: High Energy.", speaker: "Narrator", choices: [{ text: "*Jump in*", nextScene: 'level2_hub' }] },
            level2_hub: {
                id: 'level2_hub',
                bg: 'from-red-900 to-slate-900',
                character: null,
                text: "CHAPTER 2: The Truck. It's loud and bumpy.",
                speaker: "Inside Truck",
                choices: [
                    { text: "Chimney (Joking)", nextScene: 'chimney_scene', targetChar: 'chimney' },
                    { text: "Eddie (Focused)", nextScene: 'eddie_scene', targetChar: 'eddie' },
                    { text: "Arrived! (Next Chapter)", nextScene: 'level3_transition', isExit: true }
                ]
            },
            chimney_scene: {
                id: 'chimney_scene',
                bg: 'from-red-900 to-slate-900',
                character: 'chimney',
                text: "\"Did you know a group of rhinos is called a crash?\"",
                speaker: "Chimney (Meerkat)",
                choices: [
                    { text: "\"Haha! Funny.\"", nextScene: 'chimney_success', stats: { prof: 0, emp: 1, pat: 0, reg: 1, assert: 0 }, feedback: "Social connection. Laughing helps." },
                    { text: "\"MY EARS HURT!\"", nextScene: 'chimney_fail', stats: { prof: -2, emp: -1, pat: -1, reg: -3, assert: 0 }, feedback: "Losing control. Don't scream." },
                    { text: "*Dig a hole*", nextScene: 'chimney_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Dangerous behavior." },
                    { text: "\"Actually it's a stubbornness.\"", nextScene: 'chimney_fail', stats: { prof: 0, emp: -1, pat: 0, reg: 0, assert: 1 }, feedback: "Checking facts. Kills the joke. (+1 Assertive, -1 Empathetic)" }
                ]
            },
            chimney_success: { id: 'chimney_success', bg: 'from-red-900 to-slate-900', character: 'chimney', text: "\"I knew you'd get it!\"", speaker: "Chimney", choices: [{ text: "Back to seat", nextScene: 'level2_hub' }] },
            chimney_fail: { id: 'chimney_fail', bg: 'from-red-950 to-black', character: 'chimney', text: "\"Tough crowd.\"", speaker: "Chimney", choices: [{ text: "Back to seat", nextScene: 'level2_hub' }] },
            eddie_scene: {
                id: 'eddie_scene',
                bg: 'from-red-900 to-slate-900',
                character: 'eddie',
                text: "Eddie is checking buckles silently.",
                speaker: "Eddie (Rhino)",
                choices: [
                    { text: "*Wait patiently*", nextScene: 'eddie_success', stats: { prof: 1, emp: 0, pat: 2, reg: 1, assert: 0 }, feedback: "Waiting. Respecting his need for focus." },
                    { text: "\"Why is your skin thick?\"", nextScene: 'eddie_fail', stats: { prof: -1, emp: -2, pat: 0, reg: 0, assert: 0 }, feedback: "Rude question about looks." },
                    { text: "*Wrestle him*", nextScene: 'eddie_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Not safe." },
                    { text: "\"I'm scared.\"", nextScene: 'eddie_success', stats: { prof: 0, emp: 1, pat: 0, reg: 1, assert: 0 }, feedback: "Being honest. It's okay to share." }
                ]
            },
            eddie_success: { id: 'eddie_success', bg: 'from-red-900 to-slate-900', character: 'eddie', text: "\"Stay close to me.\"", speaker: "Eddie", choices: [{ text: "Back to seat", nextScene: 'level2_hub' }] },
            eddie_fail: { id: 'eddie_fail', bg: 'from-red-950 to-black', character: 'eddie', text: "\"Focus up.\"", speaker: "Eddie", choices: [{ text: "Back to seat", nextScene: 'level2_hub' }] },

            // Level 3
            level3_transition: { id: 'level3_transition', bg: 'from-slate-900 to-black', character: null, text: "Back at station. Nap time. Shhh.", speaker: "Narrator", choices: [{ text: "Enter Bunks", nextScene: 'level3_hub' }] },
            level3_hub: {
                id: 'level3_hub',
                bg: 'from-blue-950 to-slate-900',
                character: null,
                text: "CHAPTER 3: The Den. Check availability.",
                speaker: "Bunk Room",
                choices: [
                    { text: "Buck (Sleeping)", nextScene: 'l3_buck', targetChar: 'buck' },
                    { text: "Maddie (Phone)", nextScene: 'l3_maddie', targetChar: 'maddie' },
                    { text: "Eddie (Reading)", nextScene: 'l3_eddie', targetChar: 'eddie' },
                    { text: "Done. (Next Chapter)", nextScene: 'level4_transition', isExit: true }
                ]
            },
            l3_buck: {
                id: 'l3_buck',
                bg: 'from-blue-950 to-black',
                character: 'buck',
                text: "Zzzzz...",
                speaker: "Buck (Asleep)",
                choices: [
                    { text: "*Poke him* \"Wake up!\"", nextScene: 'l3_buck_fail', stats: { prof: -2, emp: -2, pat: -1, reg: -2, assert: 0 }, feedback: "Bad boundaries. Don't wake people." },
                    { text: "*Tiptoe away softly*", nextScene: 'l3_buck_success', stats: { prof: 1, emp: 1, pat: 1, reg: 1, assert: 0 }, feedback: "Respect. You noticed he wasn't available." },
                    { text: "*Cut his mane*", nextScene: 'l3_buck_fail', stats: { prof: -3, emp: -3, pat: 0, reg: -3, assert: 2 }, feedback: "Crazy Cuckoo! Never touch without asking." },
                    { text: "*Find something else*", nextScene: 'l3_buck_success', stats: { prof: 0, emp: 0, pat: 1, reg: 1, assert: 0 }, feedback: "Calming yourself. Handling boredom well." }
                ]
            },
            l3_buck_success: { id: 'l3_buck_success', bg: 'from-blue-950 to-black', character: null, text: "He sleeps on.", speaker: "Narrator", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },
            l3_buck_fail: { id: 'l3_buck_fail', bg: 'from-red-900 to-black', character: 'buck', text: "\"ROAR?! WHO IS IT?!\"", speaker: "Buck", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },
            l3_maddie: {
                id: 'l3_maddie',
                bg: 'from-blue-900 to-slate-900',
                character: 'maddie',
                text: "Maddie is whispering on the phone.",
                speaker: "Maddie (Gazelle)",
                choices: [
                    { text: "*Wait nearby*", nextScene: 'l3_maddie_success', stats: { prof: 1, emp: 1, pat: 3, reg: 1, assert: 0 }, feedback: "High Patience. Perfect waiting." },
                    { text: "\"LOOK AT ME!\"", nextScene: 'l3_maddie_fail', stats: { prof: -2, emp: -1, pat: -2, reg: -1, assert: 0 }, feedback: "Interruption. Wait your turn." },
                    { text: "\"Tell the President hi!\"", nextScene: 'l3_maddie_fail', stats: { prof: 0, emp: 0, pat: 0, reg: -1, assert: 1 }, feedback: "Crazy Cuckoo! Confusing." },
                    { text: "\"I'm hungry.\"", nextScene: 'l3_maddie_fail', stats: { prof: 0, emp: 0, pat: -1, reg: 0, assert: 0 }, feedback: "Impatience." }
                ]
            },
            l3_maddie_success: { id: 'l3_maddie_success', bg: 'from-blue-900 to-slate-900', character: 'maddie', text: "\"Thanks for waiting.\"", speaker: "Maddie", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },
            l3_maddie_fail: { id: 'l3_maddie_fail', bg: 'from-blue-900 to-slate-900', character: 'maddie', text: "She walks away.", speaker: "Maddie", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },
            l3_eddie: {
                id: 'l3_eddie',
                bg: 'from-blue-900 to-slate-900',
                character: 'eddie',
                text: "Eddie is reading.",
                speaker: "Eddie",
                choices: [
                    { text: "\"Can I sit here?\"", nextScene: 'l3_eddie_sit_success', stats: { prof: 1, emp: 1, pat: 0, reg: 1, assert: 1 }, feedback: "Polite Request. Good assertive skills." },
                    { text: "\"Books are dumb.\"", nextScene: 'l3_eddie_fail', stats: { prof: 0, emp: -2, pat: 0, reg: 0, assert: 0 }, feedback: "Insult. Not nice." },
                    { text: "*Eat the book pages*", nextScene: 'l3_eddie_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Destructive." },
                    { text: "\"Whatcha reading?\"", nextScene: 'l3_eddie_book_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 0 }, feedback: "Showing interest." }
                ]
            },
            l3_eddie_sit_success: { id: 'l3_eddie_sit_success', bg: 'from-blue-900 to-slate-900', character: 'eddie', text: "\"Sure. Just keep it down.\"", speaker: "Eddie", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },
            l3_eddie_book_success: { id: 'l3_eddie_book_success', bg: 'from-blue-900 to-slate-900', character: 'eddie', text: "\"It's 'The Zen of Mud'. Surprisingly funny.\"", speaker: "Eddie", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },
            l3_eddie_fail: { id: 'l3_eddie_fail', bg: 'from-blue-900 to-slate-900', character: 'eddie', text: "He closes the book.", speaker: "Eddie", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },

            // Level 4
            level4_transition: { id: 'level4_transition', bg: 'from-purple-900 to-slate-900', character: null, text: "Next Day. Operation: Elephant Surprise Birthday. Keep the secret!", speaker: "Narrator", choices: [{ text: "*Start Planning*", nextScene: 'level4_hub' }] },
            level4_hub: {
                id: 'level4_hub',
                bg: 'from-purple-900 to-slate-900',
                character: null,
                text: "CHAPTER 4: The Secret.",
                speaker: "Party Planning",
                choices: [
                    { text: "Athena (Cake)", nextScene: 'l4_athena', targetChar: 'athena' },
                    { text: "Buck (Loose Lips)", nextScene: 'l4_buck', targetChar: 'buck' },
                    { text: "Bobby (Birthday Boy)", nextScene: 'l4_bobby', targetChar: 'bobby' },
                    { text: "Party Time! (Next Chapter)", nextScene: 'level5_transition', isExit: true }
                ]
            },
            l4_athena: {
                id: 'l4_athena',
                bg: 'from-purple-900 to-slate-900',
                character: 'athena',
                text: "\"Hide this cake.\"",
                speaker: "Athena",
                choices: [
                    { text: "*Hide it behind the kale*", nextScene: 'l4_athena_success', stats: { prof: 1, emp: 1, pat: 0, reg: 1, assert: 1 }, flag: 'ate_cake', feedback: "Problem Solving. Assertive & Smart." },
                    { text: "*Eat the cake now*", nextScene: 'l4_athena_fail', stats: { prof: -2, emp: 0, pat: -2, reg: -2, assert: 0 }, feedback: "Impulse Control. Wait! (-2 Professional)" },
                    { text: "*Throw the cake!*", nextScene: 'l4_athena_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Messy. (-3 Professional)" },
                    { text: "\"Okay.\"", nextScene: 'l4_athena_success', stats: { prof: 1, emp: 0, pat: 1, reg: 1, assert: 0 }, feedback: "Compliance. Good." }
                ]
            },
            l4_athena_success: { id: 'l4_athena_success', bg: 'from-purple-900 to-slate-900', character: 'athena', text: "\"Good work.\"", speaker: "Athena", choices: [{ text: "Back to Planning", nextScene: 'level4_hub' }] },
            l4_athena_fail: { id: 'l4_athena_fail', bg: 'from-red-900 to-black', character: 'athena', text: "\"No!\"", speaker: "Athena", choices: [{ text: "Back to Planning", nextScene: 'level4_hub' }] },
            l4_buck: {
                id: 'l4_buck',
                bg: 'from-purple-900 to-slate-900',
                character: 'buck',
                text: "\"I want to roar HAPPY BIRTHDAY!\"",
                speaker: "Buck",
                choices: [
                    { text: "\"Wait for the signal.\"", nextScene: 'l4_buck_success', stats: { prof: 1, emp: 0, pat: 2, reg: 1, assert: 1 }, feedback: "Leadership. Helping a friend wait. (+1 Assertive)" },
                    { text: "\"Do it now!\"", nextScene: 'l4_buck_fail', stats: { prof: 0, emp: -2, pat: -2, reg: 0, assert: 0 }, feedback: "Impatience. Ruined surprise." },
                    { text: "*Scream at the sun*", nextScene: 'l4_buck_success', stats: { prof: 0, emp: 0, pat: 0, reg: 0, assert: 2 }, feedback: "Crazy Cuckoo! Good redirection." },
                    { text: "\"Shhhh.\"", nextScene: 'l4_buck_success', stats: { prof: 1, emp: 0, pat: 1, reg: 1, assert: 0 }, feedback: "Regulation." }
                ]
            },
            l4_buck_success: { id: 'l4_buck_success', bg: 'from-purple-900 to-slate-900', character: 'buck', text: "\"Okay, I'll wait.\"", speaker: "Buck", choices: [{ text: "Back to Planning", nextScene: 'level4_hub' }] },
            l4_buck_fail: { id: 'l4_buck_fail', bg: 'from-purple-900 to-slate-900', character: 'buck', text: "\"Oops.\"", speaker: "Buck", choices: [{ text: "Back to Planning", nextScene: 'level4_hub' }] },
            l4_bobby: {
                id: 'l4_bobby',
                bg: 'from-purple-900 to-slate-900',
                character: 'bobby',
                text: "\"Why is everyone acting strange?\"",
                speaker: "Bobby",
                choices: [
                    { text: "\"Just cleaning!\"", nextScene: 'l4_bobby_success', stats: { prof: 0, emp: 1, pat: 1, reg: 1, assert: 0 }, feedback: "White Lie. Protected the secret. (+1 Empathetic)" },
                    { text: "\"WE MADE A CAKE!\"", nextScene: 'l4_bobby_fail', stats: { prof: 0, emp: -2, pat: -2, reg: -1, assert: 0 }, feedback: "Blurted out. Failed to wait. (-2 Empathetic)" },
                    { text: "*Run away screaming*", nextScene: 'l4_bobby_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Suspicious." },
                    { text: "\"I don't know.\"", nextScene: 'l4_bobby_success', stats: { prof: 1, emp: 0, pat: 1, reg: 1, assert: 0 }, feedback: "Playing dumb works." }
                ]
            },
            l4_bobby_success: { id: 'l4_bobby_success', bg: 'from-purple-900 to-slate-900', character: 'bobby', text: "\"Okay...\"", speaker: "Bobby", choices: [{ text: "Back to Planning", nextScene: 'level4_hub' }] },
            l4_bobby_fail: { id: 'l4_bobby_fail', bg: 'from-purple-900 to-slate-900', character: 'bobby', text: "\"A cake? Oh.\"", speaker: "Bobby", choices: [{ text: "Back to Planning", nextScene: 'level4_hub' }] },

            // Level 5 (Day 1 End)
            level5_transition: { id: 'level5_transition', bg: 'from-orange-900 to-black', character: null, text: "Sunset on the Savannah Roof. Everyone is sad because their old Captain died a year ago.", speaker: "Narrator", choices: [{ text: "*Go to Roof*", nextScene: 'level5_hub' }] },
            level5_hub: {
                id: 'level5_hub',
                bg: 'from-orange-900 to-black',
                character: null,
                text: "CHAPTER 5: The Roof. Be gentle.",
                speaker: "The Roof",
                choices: [
                    { text: "Chimney (Sad)", nextScene: 'l5_chimney', targetChar: 'chimney' },
                    { text: "Athena (Crying)", nextScene: 'l5_athena', targetChar: 'athena' },
                    { text: "End Day 1 (Sleep)", nextScene: 'day2_start', isExit: true }
                ]
            },
            l5_chimney: {
                id: 'l5_chimney',
                bg: 'from-orange-900 to-black',
                character: 'chimney',
                text: "\"I miss Pops. The herd isn't the same without him.\"",
                speaker: "Chimney",
                choices: [
                    { text: "\"I know. It's hard.\"", nextScene: 'l5_chimney_success', stats: { prof: 0, emp: 2, pat: 1, reg: 1, assert: 0 }, flag: 'comforted_chimney', feedback: "Validation. Simple words can be powerful." },
                    { text: "\"I lost a friend once too.\"", nextScene: 'l5_chimney_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 0 }, feedback: "Relating. Sharing gently helps connection." },
                    { text: "*Howl at the moon*", nextScene: 'l5_chimney_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 2 }, feedback: "Crazy Cuckoo... but spiritual? Rituals can help grief." },
                    { text: "\"Circle of life.\"", nextScene: 'l5_chimney_fail', stats: { prof: 0, emp: -2, pat: 0, reg: 0, assert: 0 }, feedback: "Too clinical. This feels cold in a sad moment. (-2 Empathetic)" }
                ]
            },
            l5_chimney_success: { id: 'l5_chimney_success', bg: 'from-orange-900 to-black', character: 'chimney', text: "\"Yeah. Thanks Ayshe.\"", speaker: "Chimney", choices: [{ text: "Back to Roof", nextScene: 'level5_hub' }] },
            l5_chimney_fail: { id: 'l5_chimney_fail', bg: 'from-orange-900 to-black', character: 'chimney', text: "\"Uh... sure.\"", speaker: "Chimney", choices: [{ text: "Back to Roof", nextScene: 'level5_hub' }] },
            l5_athena: {
                id: 'l5_athena',
                bg: 'from-orange-900 to-black',
                character: 'athena',
                text: "The Lioness is crying silently, holding a picture of Pops.",
                speaker: "Athena",
                choices: [
                    { text: "*Stand silently nearby*", nextScene: 'l5_athena_success', stats: { prof: 1, emp: 2, pat: 2, reg: 1, assert: 0 }, feedback: "Presence. Silence speaks volumes when someone is sad." },
                    { text: "\"Stop crying! Be happy!\"", nextScene: 'l5_athena_fail', stats: { prof: -2, emp: -2, pat: -1, reg: 0, assert: 0 }, feedback: "Toxic Positivity. Don't tell people how to feel." },
                    { text: "\"I fight death!\"", nextScene: 'l5_athena_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 2 }, feedback: "Crazy Cuckoo but supportive. She appreciates the loyalty." },
                    { text: "*Offer a tissue*", nextScene: 'l5_athena_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 0 }, feedback: "Helpful act. Practical support." }
                ]
            },
            l5_athena_success: { id: 'l5_athena_success', bg: 'from-orange-900 to-black', character: 'athena', text: "\"Thanks cub.\"", speaker: "Athena", choices: [{ text: "Back to Roof", nextScene: 'level5_hub' }] },
            l5_athena_fail: { id: 'l5_athena_fail', bg: 'from-orange-900 to-black', character: 'athena', text: "She turns away. \"Leave me be.\"", speaker: "Athena", choices: [{ text: "Back to Roof", nextScene: 'level5_hub' }] },

            // --- DAY 2 ---
            day2_start: {
                id: 'day2_start',
                bg: 'from-slate-900 to-slate-800',
                character: null,
                text: "DAY 2: THE STORM. Dark clouds gather over the Savanna. Rain begins to fall.",
                speaker: "Narrator",
                choices: [{ text: "Start Shift", nextScene: 'level6_briefing' }]
            },
            level6_briefing: {
                id: 'level6_briefing',
                bg: 'from-slate-800 to-slate-700',
                character: 'bobby',
                text: (flags) => flags.has('rode_bobby') 
                    ? "Bobby sighs. \"A big storm is coming. And please, Ayshe, no riding on my back today.\"" 
                    : "Bobby looks serious. \"A massive storm is hitting us. I need everyone focused.\"",
                speaker: "Bobby",
                choices: [
                    { text: "\"I'm ready, Captain.\"", nextScene: 'level6_hub', stats: { prof: 1, emp: 0, pat: 0, reg: 1, assert: 1 }, feedback: "Professional. Good confident response." },
                    { text: "\"I'm scared of thunder!\"", nextScene: 'level6_hub', stats: { prof: -1, emp: 0, pat: 0, reg: -1, assert: 0 }, feedback: "Vulnerable, but take a breath first." }
                ]
            },
            level6_hub: {
                id: 'level6_hub',
                bg: 'from-slate-700 to-slate-600',
                character: null,
                text: "CHAPTER 6: Sandbag Duty. Everyone is prepping for the flood.",
                speaker: "Station Yard",
                choices: [
                    { text: "Athena (Supervising)", nextScene: 'l6_athena', targetChar: 'athena' },
                    { text: "Buck (Lifting Heavy Bags)", nextScene: 'l6_buck', targetChar: 'buck' },
                    { text: "Done. (Next Chapter)", nextScene: 'level7_transition', isExit: true }
                ]
            },
            l6_athena: {
                id: 'l6_athena',
                bg: 'from-slate-700 to-slate-600',
                character: 'athena',
                text: (flags) => flags.has('ate_cake') 
                    ? "Athena eyes you. \"Did you eat that cake yesterday? I'm watching the emergency rations.\"" 
                    : "Athena nods. \"Good work yesterday. Keep stacking those bags.\"",
                speaker: "Athena",
                choices: [
                    { text: "\"I won't touch them, I promise.\"", nextScene: 'l6_athena_success', stats: { prof: 1, emp: 0, pat: 0, reg: 1, assert: 0 }, feedback: "Reassurance. Rebuilding trust." },
                    { text: "\"Maybe...\"", nextScene: 'l6_athena_fail', stats: { prof: -1, emp: 0, pat: 0, reg: 0, assert: 0 }, feedback: "Evasive. Not professional." },
                    { text: "*Salute* \"Yes Ma'am!\"", nextScene: 'l6_athena_success', stats: { prof: 1, emp: 0, pat: 0, reg: 0, assert: 0 }, feedback: "Respectful." }
                ]
            },
            l6_athena_success: { id: 'l6_athena_success', bg: 'from-slate-700 to-slate-600', character: 'athena', text: "\"Good. Get to work.\"", speaker: "Athena", choices: [{ text: "Return", nextScene: 'level6_hub' }] },
            l6_athena_fail: { id: 'l6_athena_fail', bg: 'from-slate-700 to-slate-600', character: 'athena', text: "\"Hmph. I'm watching you.\"", speaker: "Athena", choices: [{ text: "Return", nextScene: 'level6_hub' }] },
            l6_buck: {
                id: 'l6_buck',
                bg: 'from-slate-700 to-slate-600',
                character: 'buck',
                text: "Buck is throwing sandbags aggressively. \"This storm is going to ruin everything!\"",
                speaker: "Buck",
                choices: [
                    { text: "\"We can handle it together.\"", nextScene: 'l6_buck_success', stats: { prof: 1, emp: 1, pat: 0, reg: 1, assert: 0 }, feedback: "Teamwork. Calming." },
                    { text: "*Join in and throw bags angrily*", nextScene: 'l6_buck_fail', stats: { prof: -1, emp: 0, pat: 0, reg: -2, assert: 0 }, feedback: "Dysregulation. Feeding the chaos." },
                    { text: "\"Use your knees!\"", nextScene: 'l6_buck_success', stats: { prof: 1, emp: 0, pat: 0, reg: 0, assert: 1 }, feedback: "Practical Advice. Assertive." }
                ]
            },
            l6_buck_success: { id: 'l6_buck_success', bg: 'from-slate-700 to-slate-600', character: 'buck', text: "\"Yeah... you're right.\"", speaker: "Buck", choices: [{ text: "Return", nextScene: 'level6_hub' }] },
            l6_buck_fail: { id: 'l6_buck_fail', bg: 'from-slate-700 to-slate-600', character: 'buck', text: "\"ARGH!\"", speaker: "Buck", choices: [{ text: "Return", nextScene: 'level6_hub' }] },

            level7_transition: { id: 'level7_transition', bg: 'from-blue-800 to-slate-900', character: null, text: "The rain starts. It pours. The alarm rings for a flood rescue!", speaker: "Narrator", choices: [{ text: "*Jump in Truck*", nextScene: 'level7_scene' }] },
            level7_scene: {
                id: 'level7_scene',
                bg: 'from-blue-900 to-slate-900',
                character: 'bobby',
                text: "CHAPTER 7: The Flood. A victim is panicked on a roof. Bobby shouts orders.",
                speaker: "Bobby",
                choices: [
                    { text: "*Calm the victim down*", nextScene: 'level7_success', stats: { prof: 1, emp: 2, pat: 1, reg: 1, assert: 0 }, feedback: "Regulation co-regulation. Vital in crisis." },
                    { text: "*Yell at them to jump*", nextScene: 'level7_fail', stats: { prof: -1, emp: -2, pat: -1, reg: -1, assert: 1 }, feedback: "Too Aggressive. Scared them." },
                    { text: "*Jump in the water yourself*", nextScene: 'level7_fail', stats: { prof: -2, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Unsafe without orders." }
                ]
            },
            level7_success: { id: 'level7_success', bg: 'from-blue-900 to-slate-900', character: 'bobby', text: "\"Great work de-escalating, Ayshe.\"", speaker: "Bobby", choices: [{ text: "Next Chapter", nextScene: 'level8_hub' }] },
            level7_fail: { id: 'level7_fail', bg: 'from-blue-900 to-slate-900', character: 'bobby', text: "\"Focus! We need them calm!\"", speaker: "Bobby", choices: [{ text: "Next Chapter", nextScene: 'level8_hub' }] },

            level8_hub: {
                id: 'level8_hub',
                bg: 'from-gray-900 to-black',
                character: null,
                text: "CHAPTER 8: Power Outage. The station is dark. Tensions flare in the Bunk Room.",
                speaker: "Bunk Room (Dark)",
                choices: [
                    { text: "Hen vs Chimney (Argue)", nextScene: 'l8_conflict', targetChar: 'hen' },
                    { text: "Eddie (Quiet)", nextScene: 'l8_eddie', targetChar: 'eddie' },
                    { text: "Next Chapter", nextScene: 'level9_transition', isExit: true }
                ]
            },
            l8_conflict: {
                id: 'l8_conflict',
                bg: 'from-gray-900 to-black',
                character: 'hen',
                text: "Hen and Chimney are arguing over a flashlight. \"I had it first!\"",
                speaker: "Hen & Chimney",
                choices: [
                    { text: "\"We can share it.\"", nextScene: 'l8_conflict_success', stats: { prof: 1, emp: 1, pat: 1, reg: 1, assert: 1 }, feedback: "Mediation. Finding a middle ground." },
                    { text: "\"Stop fighting like babies!\"", nextScene: 'l8_conflict_fail', stats: { prof: -1, emp: -1, pat: 0, reg: -1, assert: 1 }, feedback: "Judgmental. Escalates conflict." },
                    { text: "*Steal the flashlight*", nextScene: 'l8_conflict_fail', stats: { prof: -2, emp: -1, pat: 0, reg: -1, assert: 2 }, feedback: "Crazy Cuckoo! Not helpful." }
                ]
            },
            l8_conflict_success: { id: 'l8_conflict_success', bg: 'from-gray-900 to-black', character: 'hen', text: "\"Fine. You're right.\"", speaker: "Hen", choices: [{ text: "Return", nextScene: 'level8_hub' }] },
            l8_conflict_fail: { id: 'l8_conflict_fail', bg: 'from-gray-900 to-black', character: 'hen', text: "\"Stay out of it!\"", speaker: "Hen", choices: [{ text: "Return", nextScene: 'level8_hub' }] },
            l8_eddie: {
                id: 'l8_eddie',
                bg: 'from-gray-900 to-black',
                character: 'eddie',
                text: "Eddie is sitting in the dark, meditating.",
                speaker: "Eddie",
                choices: [
                    { text: "*Join him silently*", nextScene: 'l8_eddie_success', stats: { prof: 0, emp: 1, pat: 2, reg: 2, assert: 0 }, feedback: "Parallel Play. Respecting his vibe." },
                    { text: "\"It's too dark!\"", nextScene: 'l8_eddie_fail', stats: { prof: 0, emp: 0, pat: -1, reg: -1, assert: 0 }, feedback: "Complaining." }
                ]
            },
            l8_eddie_success: { id: 'l8_eddie_success', bg: 'from-gray-900 to-black', character: 'eddie', text: "\"...Peaceful, isn't it?\"", speaker: "Eddie", choices: [{ text: "Return", nextScene: 'level8_hub' }] },
            l8_eddie_fail: { id: 'l8_eddie_fail', bg: 'from-gray-900 to-black', character: 'eddie', text: "\"Shh.\"", speaker: "Eddie", choices: [{ text: "Return", nextScene: 'level8_hub' }] },

            // CHAPTER 9
            level9_transition: { id: 'level9_transition', bg: 'from-slate-800 to-slate-900', character: null, text: "The power comes back, but the station is a muddy mess. Time for cleanup.", speaker: "Narrator", choices: [{ text: "*Start Cleaning*", nextScene: 'level9_hub' }] },
            level9_hub: {
                id: 'level9_hub',
                bg: 'from-slate-800 to-slate-900',
                character: null,
                text: "CHAPTER 9: The Cleanup. Everyone is tired and grumpy.",
                speaker: "Muddy Station",
                choices: [
                    { text: "Buck (Scrubbing)", nextScene: 'l9_buck', targetChar: 'buck' },
                    { text: "Athena (Inspecting)", nextScene: 'l9_athena', targetChar: 'athena' },
                    { text: "Done. (Next Chapter)", nextScene: 'level10_transition', isExit: true }
                ]
            },
            l9_buck: {
                id: 'l9_buck',
                bg: 'from-slate-800 to-slate-900',
                character: 'buck',
                text: "Buck is scrubbing the floor aggressively. He's covered in mud.",
                speaker: "Buck",
                choices: [
                    { text: "*Grab a mop silently*", nextScene: 'l9_buck_success', stats: { prof: 1, emp: 1, pat: 0, reg: 1, assert: 0 }, feedback: "Helping. Actions speak louder than words." },
                    { text: "\"You missed a spot.\"", nextScene: 'l9_buck_fail', stats: { prof: -1, emp: -2, pat: 0, reg: 0, assert: 0 }, feedback: "Criticism. Not helpful when he's working hard." },
                    { text: "*Throw mud at him*", nextScene: 'l9_buck_fail', stats: { prof: -2, emp: 0, pat: 0, reg: -2, assert: 1 }, feedback: "Crazy Cuckoo! Now you have to clean more." }
                ]
            },
            l9_buck_success: { id: 'l9_buck_success', bg: 'from-slate-800 to-slate-900', character: 'buck', text: "\"Thanks partner. This mud is stubborn.\"", speaker: "Buck", choices: [{ text: "Return", nextScene: 'level9_hub' }] },
            l9_buck_fail: { id: 'l9_buck_fail', bg: 'from-slate-800 to-slate-900', character: 'buck', text: "\"Hey! Watch it!\"", speaker: "Buck", choices: [{ text: "Return", nextScene: 'level9_hub' }] },
            l9_athena: {
                id: 'l9_athena',
                bg: 'from-slate-800 to-slate-900',
                character: 'athena',
                text: "Athena finds a muddy footprint. \"Who tracked this in?!\"",
                speaker: "Athena",
                choices: [
                    { text: "\"I'll clean it up.\"", nextScene: 'l9_athena_success', stats: { prof: 1, emp: 0, pat: 0, reg: 1, assert: 1 }, feedback: "Taking Responsibility. Professional." },
                    { text: "\"It was Buck!\"", nextScene: 'l9_athena_fail', stats: { prof: -1, emp: -1, pat: 0, reg: 0, assert: 0 }, feedback: "Blaming. Throwing teammates under the bus is bad." }
                ]
            },
            l9_athena_success: { id: 'l9_athena_success', bg: 'from-slate-800 to-slate-900', character: 'athena', text: "\"Good initiative.\"", speaker: "Athena", choices: [{ text: "Return", nextScene: 'level9_hub' }] },
            l9_athena_fail: { id: 'l9_athena_fail', bg: 'from-slate-800 to-slate-900', character: 'athena', text: "\"I don't care who. Just fix it.\"", speaker: "Athena", choices: [{ text: "Return", nextScene: 'level9_hub' }] },

            // CHAPTER 10
            level10_transition: { id: 'level10_transition', bg: 'from-slate-900 to-black', character: null, text: "The station is clean. It's late night. Exhaustion sets in.", speaker: "Narrator", choices: [{ text: "*Go to Lockers*", nextScene: 'level10_scene' }] },
            level10_scene: {
                id: 'level10_scene',
                bg: 'from-slate-900 to-black',
                character: 'eddie',
                text: "CHAPTER 10: Exhaustion. Eddie is staring blankly at his locker.",
                speaker: "Eddie",
                choices: [
                    { text: "\"Go home, Eddie.\"", nextScene: 'level10_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 1 }, feedback: "Directive Care. Sometimes people need permission to rest." },
                    { text: "\"I'm tired too.\"", nextScene: 'level10_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 0 }, feedback: "Shared Feeling. Validating." },
                    { text: "*Slam locker shut*", nextScene: 'level10_fail', stats: { prof: 0, emp: -1, pat: 0, reg: -2, assert: 0 }, feedback: "Startling. He is too tired for noise." }
                ]
            },
            level10_success: { id: 'level10_success', bg: 'from-slate-900 to-black', character: 'eddie', text: "\"Yeah. Goodnight Ayshe.\"", speaker: "Eddie", choices: [{ text: "End Day 2", nextScene: 'day3_start' }] },
            level10_fail: { id: 'level10_fail', bg: 'from-slate-900 to-black', character: 'eddie', text: "\"...What?\"", speaker: "Eddie", choices: [{ text: "End Day 2", nextScene: 'day3_start' }] },

            // --- DAY 3 ---
            day3_start: {
                id: 'day3_start',
                bg: 'from-indigo-900 to-slate-900',
                character: null,
                text: "DAY 3: THE RECOVERY. The storm passed, but the team is burnt out. Media vans are outside.",
                speaker: "Narrator",
                choices: [{ text: "Start Final Shift", nextScene: 'level11_hub' }]
            },
            level11_hub: {
                id: 'level11_hub',
                bg: 'from-slate-200 to-white',
                character: null,
                text: "CHAPTER 11: Morning Crankiness. No coffee.",
                speaker: "Kitchen",
                choices: [
                    { text: "Bobby (Broken Machine)", nextScene: 'l11_bobby', targetChar: 'bobby' },
                    { text: "Hen (Neck Pain)", nextScene: 'l11_hen', targetChar: 'hen' },
                    { text: "Next Chapter", nextScene: 'level12_scene', isExit: true }
                ]
            },
            l11_bobby: {
                id: 'l11_bobby',
                bg: 'from-slate-200 to-white',
                character: 'bobby',
                text: "Bobby is staring at the broken coffee machine.",
                speaker: "Bobby",
                choices: [
                    { text: "\"I'll make a tea run.\"", nextScene: 'l11_bobby_success', stats: { prof: 1, emp: 1, pat: 0, reg: 1, assert: 1 }, feedback: "Solution Oriented. Helping the whole team." },
                    { text: "\"Fix it yourself!\"", nextScene: 'l11_bobby_fail', stats: { prof: -2, emp: -1, pat: 0, reg: -1, assert: 1 }, feedback: "Disrespectful. Everyone is stressed." },
                    { text: "*Kick the machine*", nextScene: 'l11_bobby_fail', stats: { prof: -2, emp: 0, pat: -1, reg: -2, assert: 0 }, feedback: "Crazy Cuckoo! Violence isn't the answer." }
                ]
            },
            l11_bobby_success: { id: 'l11_bobby_success', bg: 'from-slate-200 to-white', character: 'bobby', text: "\"You are a lifesaver.\"", speaker: "Bobby", choices: [{ text: "Return", nextScene: 'level11_hub' }] },
            l11_bobby_fail: { id: 'l11_bobby_fail', bg: 'from-slate-200 to-white', character: 'bobby', text: "\"Calm down.\"", speaker: "Bobby", choices: [{ text: "Return", nextScene: 'level11_hub' }] },
            l11_hen: {
                id: 'l11_hen',
                bg: 'from-slate-200 to-white',
                character: 'hen',
                text: "Hen is rubbing her long neck. \"I slept on a rock.\"",
                speaker: "Hen",
                choices: [
                    { text: "*Offer heat pack*", nextScene: 'l11_hen_success', stats: { prof: 0, emp: 2, pat: 0, reg: 0, assert: 0 }, feedback: "Care. Small gestures matter." },
                    { text: "\"My back hurts too!\"", nextScene: 'l11_hen_fail', stats: { prof: 0, emp: -1, pat: 0, reg: 0, assert: 0 }, feedback: "One-upping. Validate her pain first." }
                ]
            },
            l11_hen_success: { id: 'l11_hen_success', bg: 'from-slate-200 to-white', character: 'hen', text: "\"Oh, that's better.\"", speaker: "Hen", choices: [{ text: "Return", nextScene: 'level11_hub' }] },
            l11_hen_fail: { id: 'l11_hen_fail', bg: 'from-slate-200 to-white', character: 'hen', text: "\"Okay...\"", speaker: "Hen", choices: [{ text: "Return", nextScene: 'level11_hub' }] },

            level12_scene: {
                id: 'level12_scene',
                bg: 'from-blue-200 to-white',
                character: 'chimney',
                text: "CHAPTER 12: The Media. A Hyena Reporter with a camera approaches. \"Did Captain Bobby fail?!\"",
                speaker: "Reporter",
                choices: [
                    { text: "\"No comment.\"", nextScene: 'level12_success', stats: { prof: 2, emp: 0, pat: 1, reg: 1, assert: 1 }, feedback: "Professional. Safe answer." },
                    { text: "\"He almost dropped the guy!\"", nextScene: 'level12_fail', stats: { prof: -3, emp: -2, pat: 0, reg: -1, assert: 0 }, feedback: "Betrayal! Never gossip to press." },
                    { text: "\"It was a team effort.\"", nextScene: 'level12_success', stats: { prof: 1, emp: 1, pat: 0, reg: 1, assert: 1 }, feedback: "Diplomatic. Protects the team." }
                ]
            },
            level12_success: { id: 'level12_success', bg: 'from-blue-200 to-white', character: 'chimney', text: "(The reporter leaves disappointed)", speaker: "Narrator", choices: [{ text: "Next Chapter", nextScene: 'level13_hub' }] },
            level12_fail: { id: 'level12_fail', bg: 'from-blue-200 to-white', character: 'chimney', text: "(The reporter scribbles eagerly)", speaker: "Narrator", choices: [{ text: "Next Chapter", nextScene: 'level13_hub' }] },

            level13_hub: {
                id: 'level13_hub',
                bg: 'from-orange-100 to-white',
                character: null,
                text: "CHAPTER 13: Community Outreach. Handing out water.",
                speaker: "Community Center",
                choices: [
                    { text: "Athena (Stern)", nextScene: 'l13_athena', targetChar: 'athena' },
                    { text: "Chimney (Juggling)", nextScene: 'l13_chimney', targetChar: 'chimney' },
                    { text: "Next Chapter", nextScene: 'level14_scene', isExit: true }
                ]
            },
            l13_athena: {
                id: 'l13_athena',
                bg: 'from-orange-100 to-white',
                character: 'athena',
                text: "Athena is barking orders at citizens. \"Single file line!\"",
                speaker: "Athena",
                choices: [
                    { text: "*Help organize silently*", nextScene: 'l13_athena_success', stats: { prof: 1, emp: 0, pat: 1, reg: 1, assert: 0 }, feedback: "Supportive. Helping her goal." },
                    { text: "\"You're scaring them.\"", nextScene: 'l13_athena_fail', stats: { prof: -1, emp: 1, pat: 0, reg: 0, assert: 1 }, feedback: "Critique. You might be right, but be careful." }
                ]
            },
            l13_athena_success: { id: 'l13_athena_success', bg: 'from-orange-100 to-white', character: 'athena', text: "\"Keep them moving.\"", speaker: "Athena", choices: [{ text: "Return", nextScene: 'level13_hub' }] },
            l13_athena_fail: { id: 'l13_athena_fail', bg: 'from-orange-100 to-white', character: 'athena', text: "\"They need to listen!\"", speaker: "Athena", choices: [{ text: "Return", nextScene: 'level13_hub' }] },
            l13_chimney: {
                id: 'l13_chimney',
                bg: 'from-orange-100 to-white',
                character: 'chimney',
                text: (flags) => flags.has('comforted_chimney') 
                    ? "Chimney smiles. \"Hey Ayshe! Thanks for the talk yesterday. Watch this!\" *Juggles*"
                    : "Chimney is juggling water bottles. The kids love it.",
                speaker: "Chimney",
                choices: [
                    { text: "*Cheer him on*", nextScene: 'l13_chimney_success', stats: { prof: 0, emp: 2, pat: 0, reg: 0, assert: 0 }, feedback: "Encouragement. Boosting morale." },
                    { text: "\"Focus on work!\"", nextScene: 'l13_chimney_fail', stats: { prof: 1, emp: -1, pat: 0, reg: 0, assert: 1 }, feedback: "Buzzkill. Morale is work too." }
                ]
            },
            l13_chimney_success: { id: 'l13_chimney_success', bg: 'from-orange-100 to-white', character: 'chimney', text: "\"Ta-da!\"", speaker: "Chimney", choices: [{ text: "Return", nextScene: 'level13_hub' }] },
            l13_chimney_fail: { id: 'l13_chimney_fail', bg: 'from-orange-100 to-white', character: 'chimney', text: "\"Okay, okay.\"", speaker: "Chimney", choices: [{ text: "Return", nextScene: 'level13_hub' }] },

            level14_scene: {
                id: 'level14_scene',
                bg: 'from-indigo-900 to-black',
                character: 'maddie',
                text: "CHAPTER 14: Burnout. Maddie is crying on the phone in the bunks.",
                speaker: "Maddie",
                choices: [
                    { text: "*Close door gently*", nextScene: 'level14_success', stats: { prof: 1, emp: 2, pat: 1, reg: 1, assert: 0 }, feedback: "Privacy. Respecting her space is empathetic." },
                    { text: "\"What's wrong now?\"", nextScene: 'level14_fail', stats: { prof: 0, emp: -2, pat: -1, reg: 0, assert: 0 }, feedback: "Impatient. She needs space, not questions." },
                    { text: "*Start singing loudly*", nextScene: 'level14_fail', stats: { prof: -2, emp: -2, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Inappropriate." }
                ]
            },
            level14_success: { id: 'level14_success', bg: 'from-indigo-900 to-black', character: 'maddie', text: "(She nods thanks)", speaker: "Narrator", choices: [{ text: "Next Chapter", nextScene: 'level15_scene' }] },
            level14_fail: { id: 'level14_fail', bg: 'from-indigo-900 to-black', character: 'maddie', text: "\"Please leave.\"", speaker: "Maddie", choices: [{ text: "Next Chapter", nextScene: 'level15_scene' }] },

            level15_scene: {
                id: 'level15_scene',
                bg: 'from-yellow-100 to-white',
                character: 'bobby',
                text: "CHAPTER 15: The Ceremony. The Mayor is giving medals. \"And the hero of the storm is... Buck!\"",
                speaker: "Mayor",
                choices: [
                    { text: "*Clap loudly*", nextScene: 'day4_start', stats: { prof: 1, emp: 1, pat: 0, reg: 1, assert: 0 }, feedback: "Sportsmanship. Celebrating others." },
                    { text: "\"What about me?!\"", nextScene: 'day4_start', stats: { prof: -2, emp: -1, pat: -1, reg: -2, assert: 1 }, feedback: "Jealousy. Not the time." },
                    { text: "*Steal the medal*", nextScene: 'day4_start', stats: { prof: -3, emp: 0, pat: 0, reg: -3, assert: 2 }, feedback: "Crazy Cuckoo! You can't steal glory." }
                ]
            },

            // --- DAY 4: THE GRAND PARADE ---
            day4_start: {
                id: 'day4_start',
                bg: 'from-yellow-200 to-orange-100',
                character: null,
                text: "DAY 4: THE GRAND PARADE. The Savanna is celebrating the rescue. It's time for a party!",
                speaker: "Narrator",
                choices: [{ text: "Start Day 4", nextScene: 'level16_scene' }]
            },
            level16_scene: {
                id: 'level16_scene',
                bg: 'from-blue-100 to-white',
                character: 'bobby',
                text: "CHAPTER 16: Uniform Inspection. Bobby is checking buttons.",
                speaker: "Bobby",
                choices: [
                    { text: "*Stand up straight*", nextScene: 'level16_success', stats: { prof: 2, emp: 0, pat: 1, reg: 1, assert: 0 }, feedback: "Acting like a pro. Good job." },
                    { text: "\"This shirt is itchy!\"", nextScene: 'level16_fail', stats: { prof: -1, emp: 0, pat: -1, reg: -1, assert: 0 }, feedback: "Complaining at work. Not professional." },
                    { text: "*Wear pants on head*", nextScene: 'level16_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! That is not the uniform!" }
                ]
            },
            level16_success: { id: 'level16_success', bg: 'from-blue-100 to-white', character: 'bobby', text: "\"Looking sharp, Ayshe.\"", speaker: "Bobby", choices: [{ text: "Next Chapter", nextScene: 'level17_scene' }] },
            level16_fail: { id: 'level16_fail', bg: 'from-blue-100 to-white', character: 'bobby', text: "\"Fix that. Now.\"", speaker: "Bobby", choices: [{ text: "Next Chapter", nextScene: 'level17_scene' }] },

            level17_scene: {
                id: 'level17_scene',
                bg: 'from-pink-100 to-white',
                character: 'hen',
                text: "CHAPTER 17: Float Decoration. Hen wants flowers. Chimney wants sirens.",
                speaker: "Hen & Chimney",
                choices: [
                    { text: "\"Let's use both!\"", nextScene: 'level17_success', stats: { prof: 1, emp: 2, pat: 0, reg: 0, assert: 1 }, feedback: "Helping friends agree. Great teamwork!" },
                    { text: "\"Sirens are cooler!\"", nextScene: 'level17_fail', stats: { prof: 0, emp: -1, pat: 0, reg: 0, assert: 1 }, feedback: "Taking sides. Now Hen is sad." },
                    { text: "*Eat the flowers*", nextScene: 'level17_fail', stats: { prof: -2, emp: 0, pat: 0, reg: -2, assert: 0 }, feedback: "Crazy Cuckoo! Those are for the float!" }
                ]
            },
            level17_success: { id: 'level17_success', bg: 'from-pink-100 to-white', character: 'hen', text: "\"Good idea! Flower sirens!\"", speaker: "Hen", choices: [{ text: "Next Chapter", nextScene: 'level18_scene' }] },
            level17_fail: { id: 'level17_fail', bg: 'from-pink-100 to-white', character: 'hen', text: "\"Fine... whatever.\"", speaker: "Hen", choices: [{ text: "Next Chapter", nextScene: 'level18_scene' }] },

            level18_scene: {
                id: 'level18_scene',
                bg: 'from-yellow-400 to-orange-500',
                character: 'buck',
                text: "CHAPTER 18: The Crowd. Thousands of animals are cheering loudly. It is VERY loud.",
                speaker: "The Crowd",
                choices: [
                    { text: "*Wave and smile*", nextScene: 'level18_success', stats: { prof: 1, emp: 1, pat: 1, reg: 2, assert: 0 }, feedback: "Staying calm. Good job managing the noise." },
                    { text: "*Cover ears and scream*", nextScene: 'level18_fail', stats: { prof: -1, emp: 0, pat: 0, reg: -2, assert: 0 }, feedback: "Losing control. The crowd gets scared." },
                    { text: "*Jump into the crowd*", nextScene: 'level18_fail', stats: { prof: -2, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Stay on the float!" }
                ]
            },
            level18_success: { id: 'level18_success', bg: 'from-yellow-400 to-orange-500', character: 'buck', text: "\"They love us!\"", speaker: "Buck", choices: [{ text: "Next Chapter", nextScene: 'level19_scene' }] },
            level18_fail: { id: 'level18_fail', bg: 'from-yellow-400 to-orange-500', character: 'buck', text: "\"Pull it together!\"", speaker: "Buck", choices: [{ text: "Next Chapter", nextScene: 'level19_scene' }] },

            level19_scene: {
                id: 'level19_scene',
                bg: 'from-gray-200 to-white',
                character: 'athena',
                text: "CHAPTER 19: Lost Cub. A baby zebra is crying alone.",
                speaker: "Lost Zebra",
                choices: [
                    { text: "\"Are you lost? I can help.\"", nextScene: 'level19_success', stats: { prof: 1, emp: 3, pat: 1, reg: 1, assert: 1 }, feedback: "Super caring! You are safe and helpful." },
                    { text: "\"Where is your mom?!\"", nextScene: 'level19_fail', stats: { prof: 0, emp: -1, pat: -1, reg: 0, assert: 0 }, feedback: "Too loud. You scared the baby." },
                    { text: "*Walk away*", nextScene: 'level19_fail', stats: { prof: -2, emp: -2, pat: 0, reg: 0, assert: 0 }, feedback: "Ignoring help. Not a hero move." }
                ]
            },
            level19_success: { id: 'level19_success', bg: 'from-gray-200 to-white', character: 'athena', text: "\"Good eye, Ayshe. We found the mom.\"", speaker: "Athena", choices: [{ text: "Next Chapter", nextScene: 'level20_scene' }] },
            level19_fail: { id: 'level19_fail', bg: 'from-gray-200 to-white', character: 'athena', text: "\"I'll handle it. Pay attention.\"", speaker: "Athena", choices: [{ text: "Next Chapter", nextScene: 'level20_scene' }] },

            level20_scene: {
                id: 'level20_scene',
                bg: 'from-purple-900 to-black',
                character: 'bobby',
                text: "CHAPTER 20: The Fireworks. The day ends with a beautiful show.",
                speaker: "Bobby",
                choices: [
                    { text: "\"Great job everyone!\"", nextScene: 'day5_start', stats: { prof: 1, emp: 1, pat: 0, reg: 1, assert: 1 }, feedback: "Positive ending. Celebrating the team." },
                    { text: "\"I'm tired. Going home.\"", nextScene: 'day5_start', stats: { prof: 0, emp: 0, pat: 0, reg: 0, assert: 0 }, feedback: "Honest, but a bit abrupt." },
                    { text: "*Try to catch a firework*", nextScene: 'day5_start', stats: { prof: -3, emp: 0, pat: 0, reg: -3, assert: 2 }, feedback: "Crazy Cuckoo! Extremely dangerous!" }
                ]
            },

            // --- DAY 5: THE WILDFIRE ---
            day5_start: {
                id: 'day5_start',
                bg: 'from-red-900 to-black',
                character: 'bobby',
                text: "DAY 5: THE WILDFIRE. A massive fire is moving fast towards the station! This is a Crisis.",
                speaker: "Narrator",
                choices: [{ text: "Report for Duty", nextScene: 'level21_scene' }]
            },
            level21_scene: {
                id: 'level21_scene',
                bg: 'from-orange-600 to-red-900',
                character: 'bobby',
                text: "CHAPTER 21: Evacuation. A civilian refuses to leave their home. The fire is close.",
                speaker: "Civilian",
                choices: [
                    { text: "\"We leave in 2 minutes, with or without you.\"", nextScene: 'level21_success', stats: { prof: 2, emp: -1, pat: 0, reg: 1, assert: 2 }, feedback: "Hard Truth. Sometimes safety > politeness." },
                    { text: "\"Please, it's not safe!\"", nextScene: 'level21_fail', stats: { prof: 0, emp: 1, pat: 1, reg: -1, assert: -1 }, feedback: "Too soft. We don't have time to beg." },
                    { text: "*Throw them in the truck*", nextScene: 'level21_fail', stats: { prof: -2, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! You can't kidnap people!" }
                ]
            },
            level21_success: { id: 'level21_success', bg: 'from-orange-600 to-red-900', character: 'bobby', text: "\"They're moving! Good firmness, Ayshe.\"", speaker: "Bobby", choices: [{ text: "Next Chapter", nextScene: 'level22_hub' }] },
            level21_fail: { id: 'level21_fail', bg: 'from-orange-600 to-red-900', character: 'bobby', text: "\"We lost too much time! Move!\"", speaker: "Bobby", choices: [{ text: "Next Chapter", nextScene: 'level22_hub' }] },

            level22_hub: {
                id: 'level22_hub',
                bg: 'from-red-900 to-black',
                character: null,
                text: "CHAPTER 22: Supplies Low. The water is running out. Everyone is stressed.",
                speaker: "Fire Line",
                choices: [
                    { text: "Buck (Panicking)", nextScene: 'l22_buck', targetChar: 'buck' },
                    { text: "Eddie (Overworking)", nextScene: 'l22_eddie', targetChar: 'eddie' },
                    { text: "Next Chapter", nextScene: 'level23_scene', isExit: true }
                ]
            },
            l22_buck: {
                id: 'l22_buck',
                bg: 'from-red-900 to-black',
                character: 'buck',
                text: "\"There's not enough water! We're gonna fail!\"",
                speaker: "Buck",
                choices: [
                    { text: "\"Share my ration with him.\"", nextScene: 'l22_buck_success', stats: { prof: 1, emp: 2, pat: 0, reg: 0, assert: 0 }, feedback: "Sacrifice. Very noble." },
                    { text: "\"Pull it together, soldier!\"", nextScene: 'l22_buck_fail', stats: { prof: 1, emp: -1, pat: -1, reg: 0, assert: 1 }, feedback: "Too harsh. He needs support, not orders." },
                    { text: "*Drink all the water*", nextScene: 'l22_buck_fail', stats: { prof: -2, emp: -2, pat: 0, reg: -1, assert: 0 }, feedback: "Selfish! Not a team player." }
                ]
            },
            l22_buck_success: { id: 'l22_buck_success', bg: 'from-red-900 to-black', character: 'buck', text: "\"Thanks... I needed that.\"", speaker: "Buck", choices: [{ text: "Return", nextScene: 'level22_hub' }] },
            l22_buck_fail: { id: 'l22_buck_fail', bg: 'from-red-900 to-black', character: 'buck', text: "\"...Right. Sorry.\"", speaker: "Buck", choices: [{ text: "Return", nextScene: 'level22_hub' }] },
            l22_eddie: {
                id: 'l22_eddie',
                bg: 'from-red-900 to-black',
                character: 'eddie',
                text: "Eddie is digging a trench alone. He looks ready to collapse.",
                speaker: "Eddie",
                choices: [
                    { text: "\"Take a break, I'll dig.\"", nextScene: 'l22_eddie_success', stats: { prof: 1, emp: 2, pat: 0, reg: 0, assert: 1 }, feedback: "Stepping up. Giving him relief." },
                    { text: "\"Dig faster!\"", nextScene: 'l22_eddie_fail', stats: { prof: 0, emp: -2, pat: -1, reg: 0, assert: 0 }, feedback: "Cruel. He is at his limit." }
                ]
            },
            l22_eddie_success: { id: 'l22_eddie_success', bg: 'from-red-900 to-black', character: 'eddie', text: "(He collapses in gratitude)", speaker: "Eddie", choices: [{ text: "Return", nextScene: 'level22_hub' }] },
            l22_eddie_fail: { id: 'l22_eddie_fail', bg: 'from-red-900 to-black', character: 'eddie', text: "(He ignores you and keeps digging)", speaker: "Eddie", choices: [{ text: "Return", nextScene: 'level22_hub' }] },

            level23_scene: {
                id: 'level23_scene',
                bg: 'from-red-500 to-orange-500',
                character: 'chimney',
                text: "CHAPTER 23: The Injury. Chimney twisted his ankle but wants to keep working.",
                speaker: "Chimney",
                choices: [
                    { text: "\"You're hurt. Radio duty only.\"", nextScene: 'level23_success', stats: { prof: 2, emp: 1, pat: 0, reg: 1, assert: 2 }, feedback: "Perfect Call. Safe but still values him." },
                    { text: "\"You're tough! Keep going!\"", nextScene: 'level23_fail', stats: { prof: -2, emp: 1, pat: 0, reg: -1, assert: 0 }, feedback: "Dangerous! Being nice isn't always safe." },
                    { text: "\"Sit down, liability.\"", nextScene: 'level23_fail', stats: { prof: 1, emp: -3, pat: 0, reg: 0, assert: 1 }, feedback: "Mean. True, but hurtful." }
                ]
            },
            level23_success: { id: 'level23_success', bg: 'from-red-500 to-orange-500', character: 'chimney', text: "\"Fine. I'll man the comms.\"", speaker: "Chimney", choices: [{ text: "Next Chapter", nextScene: 'level24_scene' }] },
            level23_fail: { id: 'level23_fail', bg: 'from-red-500 to-orange-500', character: 'chimney', text: "\"Ouch! Okay, maybe you're right...\"", speaker: "Chimney", choices: [{ text: "Next Chapter", nextScene: 'level24_scene' }] },

            level24_scene: {
                id: 'level24_scene',
                bg: 'from-blue-200 to-white',
                character: 'chimney',
                text: "CHAPTER 24: The Ambush. A reporter asks: \"Is the fire the department's fault?!\"",
                speaker: "Reporter",
                choices: [
                    { text: "\"No comment.\"", nextScene: 'level24_success', stats: { prof: 2, emp: 0, pat: 1, reg: 1, assert: 0 }, feedback: "Safe. Boring but correct." },
                    { text: "\"We are doing our best!\"", nextScene: 'level24_success', stats: { prof: 0, emp: 2, pat: 0, reg: 0, assert: 1 }, feedback: "Honest. The public likes heart." },
                    { text: "*Steal the microphone*", nextScene: 'level24_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -3, assert: 2 }, feedback: "Crazy Cuckoo! Arrested on live TV!" },
                    { text: "\"It's nature's fault!\"", nextScene: 'level24_fail', stats: { prof: -1, emp: 0, pat: -1, reg: -1, assert: 1 }, feedback: "Defensive. Makes us look guilty." }
                ]
            },
            level24_success: { id: 'level24_success', bg: 'from-blue-200 to-white', character: 'chimney', text: "(Reporter nods)", speaker: "Narrator", choices: [{ text: "Next Chapter", nextScene: 'level25_scene' }] },
            level24_fail: { id: 'level24_fail', bg: 'from-blue-200 to-white', character: 'chimney', text: "\"Interesting...\"", speaker: "Reporter", choices: [{ text: "Next Chapter", nextScene: 'level25_scene' }] },

            level25_scene: {
                id: 'level25_scene',
                bg: 'from-red-900 to-black',
                character: 'bobby',
                text: "CHAPTER 25: The Hard Call. The station is burning. You can save ONE thing.",
                speaker: "The Fire",
                choices: [
                    { text: "*Save the Medical Kit*", nextScene: 'end_game', stats: { prof: 3, emp: 0, pat: 0, reg: 2, assert: 1 }, feedback: "Practical. Lives over memories. (+3 Prof)" },
                    { text: "*Save Pops' Photo*", nextScene: 'end_game', stats: { prof: -1, emp: 3, pat: 0, reg: 0, assert: 0 }, feedback: "Sentimental. The heart of the team. (+3 Emp)" },
                    { text: "*Save both (Risk Dropping)*", nextScene: 'end_game', stats: { prof: -1, emp: 1, pat: -1, reg: -1, assert: 1 }, feedback: "Greedy. You dropped the kit. (-1 Prof)" },
                    { text: "*Burn the photo*", nextScene: 'end_game', stats: { prof: -3, emp: -3, pat: 0, reg: -3, assert: 0 }, feedback: "Crazy Cuckoo! Why?!" }
                ]
            },

            game_over: { id: 'game_over', bg: 'from-red-900 to-black', character: null, text: "GAME OVER. Your stats dropped too low.", speaker: "System", choices: [{ text: "Retry Chapter", action: 'retry' }, { text: "Restart Shift", nextScene: 'start' }] },
            win_game: { id: 'win_game', bg: 'from-yellow-400 to-orange-500', character: null, text: "Shift Complete!", speaker: "System", choices: [{ text: "Play Again", nextScene: 'start' }] }
        };

        function SocialSimGameV10() {
            const [currentSceneId, setCurrentSceneId] = useState('start');
            const [lastChapterStart, setLastChapterStart] = useState('start');
            const [stats, setStats] = useState({ emp: 5, prof: 5, assert: 5, pat: 5, reg: 5 }); // 5 Stats
            const [feedback, setFeedback] = useState(null);
            const [visited, setVisited] = useState(new Set());
            const [flags, setFlags] = useState(new Set());
            const [scoreAnimations, setScoreAnimations] = useState([]);
            const [shaken, setShaken] = useState(false);
            const [currentChoices, setCurrentChoices] = useState([]);
            const [reduceMotion, setReduceMotion] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [winMessage, setWinMessage] = useState("");
            const { speak, stop, isSpeaking } = useTextToSpeech();

            const scene = SCENES[currentSceneId];

            // Share functionality
            const handleShare = () => {
                const subject = encodeURIComponent("My Savanna Squad Score Report");
                const bodyText = `I finished my 5-Day Shift at the Savanna 118!\n\nMy Stats:\n` +
                    ` Caring: ${stats.emp}/10\n` +
                    ` Professional: ${stats.prof}/10\n` +
                    ` Speaking Up: ${stats.assert}/10\n` +
                    ` Patient: ${stats.pat}/10\n` +
                    ` Calm: ${stats.reg}/10\n\n` +
                    `Can you beat my score?`;
                const body = encodeURIComponent(bodyText);
                const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&su=${subject}&body=${body}`;
                window.open(gmailLink, '_blank');
            };

            // Transition Logic with Auto-Skip
            const transitionToScene = (targetSceneId) => {
                if (targetSceneId === 'end_game') {
                    // Check if survive (no stats <= 0)
                    const survival = Object.values(stats).every(val => val > 0);
                    if (survival) {
                        // Generate dynamic win message
                        const perfect = Object.values(stats).every(val => val >= 10);
                        let msg = "";
                        
                        if (perfect) {
                            msg = "LEGENDARY 5-DAY SHIFT! You saved the station! (10/10 in everything!)";
                        } else {
                            const highs = Object.entries(stats).filter(([k,v]) => v >= 9).map(([k]) => {
                                const map = { emp: 'Caring', prof: 'Professional', assert: 'Speaking Up', pat: 'Patient', reg: 'Calm' };
                                return map[k];
                            });
                            const lows = Object.entries(stats).filter(([k,v]) => v <= 4).map(([k]) => {
                                const map = { emp: 'Caring', prof: 'Professional', assert: 'Speaking Up', pat: 'Patient', reg: 'Calm' };
                                return map[k];
                            });
                            
                            msg = "5-Day Shift Complete! You survived the fire!";
                            if (highs.length > 0) msg += ` You were super ${highs.join(' & ')}!`;
                            if (lows.length > 0) msg += ` But you can work on being more ${lows.join(' & ')}.`;
                            if (highs.length === 0 && lows.length === 0) msg += " You had a solid, balanced performance.";
                        }
                        
                        setWinMessage(msg);
                        setCurrentSceneId('win_game');
                        return;
                    }
                }

                // Check for Auto-Skip in Hubs
                const targetScene = SCENES[targetSceneId];
                if (targetSceneId.includes('hub') && targetScene) {
                    const available = targetScene.choices.filter(c => {
                        if (c.isExit) return true;
                        if (c.action) return true;
                        if (!c.targetChar) return true;
                        return !visited.has(c.targetChar);
                    });

                    // If only exit remains, skip the hub
                    if (available.length === 1 && available[0].isExit) {
                        transitionToScene(available[0].nextScene);
                        return;
                    }
                }
                setCurrentSceneId(targetSceneId);
            };

            // Choice Shuffling
            useEffect(() => {
                if (!scene) return;
                let available = scene.choices.filter(c => {
                    if (c.isExit) return true;
                    if (c.action) return true;
                    if (!c.targetChar) return true;
                    return !visited.has(c.targetChar);
                });

                const exitOption = available.find(c => c.isExit || c.action === 'retry' || c.text === 'Start my shift' || c.text === 'Play Again');
                let others = available.filter(c => c !== exitOption);

                // Fisher-Yates Shuffle
                for (let i = others.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [others[i], others[j]] = [others[j], others[i]];
                }

                if (exitOption) others.push(exitOption);
                
                if (currentSceneId === 'game_over') {
                    setCurrentChoices(scene.choices);
                } else {
                    setCurrentChoices(others);
                }
            }, [currentSceneId, visited, scene]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (feedback) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            handleFeedbackDismiss();
                        }
                        return;
                    }
                    const keyMap = { '1': 0, '2': 1, '3': 2, '4': 3 };
                    if (keyMap.hasOwnProperty(e.key)) {
                        const index = keyMap[e.key];
                        if (currentChoices[index]) handleChoice(currentChoices[index]);
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [currentChoices, feedback]);

            useEffect(() => {
                if (currentSceneId.includes('hub') || currentSceneId === 'start') setLastChapterStart(currentSceneId);
                if (currentSceneId.includes('transition') || currentSceneId === 'start') setVisited(new Set());
            }, [currentSceneId]);

            useEffect(() => {
                if (currentSceneId === 'start') return;
                if (Object.values(stats).some(v => v <= 0) && currentSceneId !== 'game_over') {
                    setCurrentSceneId('game_over');
                    stop();
                }
            }, [stats, currentSceneId]);

            const addScoreAnimation = (statName, val) => {
                if (reduceMotion) return;
                const id = Date.now() + Math.random();
                setScoreAnimations(prev => [...prev, { id, statName, val }]);
                setTimeout(() => setScoreAnimations(prev => prev.filter(a => a.id !== id)), 1000);
            };

            const handleChoice = (choice) => {
                stop();
                
                // Random Event Trigger (15% chance)
                if (!choice.action && !choice.isExit && Math.random() < 0.15) {
                    const event = RANDOM_EVENTS[Math.floor(Math.random() * RANDOM_EVENTS.length)];
                    // Apply random event stats
                    if (event.effect) {
                        Object.keys(event.effect).forEach(key => {
                            addScoreAnimation(key, event.effect[key]);
                        });
                        setStats(prev => {
                            const newStats = { ...prev };
                            Object.keys(event.effect).forEach(key => {
                                newStats[key] = Math.max(0, Math.min(10, prev[key] + event.effect[key]));
                            });
                            return newStats;
                        });
                    }
                    // Show event in feedback modal style
                    setFeedback({ 
                        message: `LIFE EVENT: ${event.text}`, 
                        nextScene: choice.nextScene, // Proceed to intended scene after
                        statChange: event.effect
                    });
                    
                    // Apply choice stats as well? Or skip? Let's apply choice stats too so player isn't cheated.
                    if (choice.stats) {
                         setStats(prev => {
                            const newStats = { ...prev };
                            Object.keys(choice.stats).forEach(key => {
                                newStats[key] = Math.max(0, Math.min(10, prev[key] + choice.stats[key]));
                            });
                            return newStats;
                        });
                    }
                    if (choice.targetChar) setVisited(prev => new Set(prev).add(choice.targetChar));
                    return; // Stop here, feedback modal handles transition
                }


                if (choice.action === 'retry') {
                    setStats({ emp: 5, prof: 5, assert: 5, pat: 5, reg: 5 });
                    setVisited(new Set());
                    setCurrentSceneId(lastChapterStart);
                    return;
                }
                if (choice.stats) {
                    // Update all 5 stats
                    Object.keys(choice.stats).forEach(key => {
                        if (choice.stats[key] !== 0) addScoreAnimation(key, choice.stats[key]);
                    });

                    setStats(prev => {
                        const newStats = { ...prev };
                        Object.keys(choice.stats).forEach(key => {
                            newStats[key] = Math.max(0, Math.min(10, prev[key] + choice.stats[key]));
                        });
                        return newStats;
                    });

                    if (!reduceMotion) {
                        const isBad = Object.values(choice.stats).some(v => v < 0);
                        const isGood = Object.values(choice.stats).every(v => v >= 0) && Object.values(choice.stats).some(v => v > 0);
                        
                        if (isBad) {
                            setShaken(true);
                            setTimeout(() => setShaken(false), 500);
                        }
                        if (isGood) {
                            window.confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 }, colors: ['#4F46E5', '#EC4899', '#F59E0B'] });
                        }
                    }
                }
                
                // Flag tracking
                if (choice.flag) {
                    setFlags(prev => new Set(prev).add(choice.flag));
                }

                if (choice.targetChar) setVisited(prev => new Set(prev).add(choice.targetChar));
                if (choice.feedback) {
                    setFeedback({ message: choice.feedback, nextScene: choice.nextScene, statChange: choice.stats });
                } else {
                    if (choice.nextScene) transitionToScene(choice.nextScene);
                }
            };

            const handleFeedbackDismiss = () => {
                stop();
                if (feedback) {
                    if (feedback.nextScene) transitionToScene(feedback.nextScene);
                    setFeedback(null);
                }
            };

            const resetGame = () => {
                stop();
                setCurrentSceneId('start');
                setStats({ emp: 5, prof: 5, assert: 5, pat: 5, reg: 5 });
                setFeedback(null);
                setVisited(new Set());
                setFlags(new Set());
                setWinMessage("");
            };

            const readCurrentScene = () => {
                let textToRead = "";
                if (feedback) {
                    textToRead = `Review. ${feedback.message}. Click continue.`;
                } else {
                    // Handle dynamic text function
                    let displayText = typeof scene.text === 'function' ? scene.text(flags) : (currentSceneId === 'win_game' ? winMessage : scene.text);

                    if (scene.speaker === 'Narrator' || scene.speaker.includes('Watering Hole') || scene.speaker.includes('Truck') || scene.speaker.includes('Bunk') || scene.speaker.includes('Roof') || scene.speaker.includes('Planning') || scene.speaker.includes('Station') || scene.speaker.includes('Community') || scene.speaker.includes('Muddy') || scene.speaker === 'System') {
                        textToRead = `${displayText} `;
                    } else {
                        textToRead = `${scene.speaker} says: ${displayText} `;
                    }
                    currentChoices.forEach((choice, idx) => {
                        textToRead += `Option ${idx + 1}: ${choice.text}. `;
                    });
                }
                speak(textToRead);
            };

            // Stat Bar Component
            const StatBar = ({ label, value, icon, colorClass, barColorClass, statKey }) => (
                <div className="flex flex-col mb-2 relative">
                    {scoreAnimations.filter(a => a.statName === statKey).map(anim => (
                        <div key={anim.id} className={`absolute right-0 -top-4 text-lg font-black ${anim.val > 0 ? 'text-green-400' : 'text-red-500'} animate-float z-50`}>
                            {anim.val > 0 ? '+' : ''}{anim.val}
                        </div>
                    ))}
                    <div className="flex items-center gap-2 mb-1">
                        <Icon path={icon} className={colorClass} size={16} />
                        <span className={`text-[10px] font-bold uppercase tracking-wider ${colorClass}`}>{label}</span>
                        {value >= 10 && <Icon path={ICONS.Star} className="text-yellow-400 ml-1" size={14} />}
                        <span className="ml-auto text-xs font-bold text-slate-400">{value}/10</span>
                    </div>
                    <div className="w-full h-2 bg-slate-800 rounded-full overflow-hidden shadow-inner border border-slate-700">
                        <div className={`h-full transition-all duration-500 ease-out ${value >= 10 ? 'bg-yellow-400' : barColorClass} ${value <= 2 ? 'animate-pulse bg-red-500' : ''}`} style={{ width: `${Math.min(100, value * 10)}%` }} />
                    </div>
                </div>
            );

            return (
                <div className={`min-h-screen flex items-center justify-center p-4 font-sans bg-slate-950 text-slate-100 ${shaken ? 'animate-shake' : ''}`}>
                    {/* Settings */}
                    <div className="fixed top-4 right-4 z-50">
                        <button onClick={() => setShowSettings(!showSettings)} className="p-2 bg-slate-800 rounded-full hover:bg-slate-700 text-slate-300 border border-slate-700 shadow-lg">
                            <Icon path={ICONS.Settings} />
                        </button>
                        {showSettings && (
                            <div className="absolute right-0 mt-2 w-48 bg-slate-800 border border-slate-700 rounded-xl shadow-xl p-4 animate-pop origin-top-right">
                                <h4 className="font-bold text-sm mb-3 text-slate-400">Settings</h4>
                                <label className="flex items-center justify-between cursor-pointer">
                                    <span className="text-sm">Calm Mode (No Shake)</span>
                                    <input type="checkbox" checked={reduceMotion} onChange={(e) => setReduceMotion(e.target.checked)} className="accent-indigo-500 w-4 h-4" />
                                </label>
                            </div>
                        )}
                    </div>

                    <div className="relative w-full max-w-6xl bg-slate-900/90 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row h-[750px] border border-slate-800">
                        
                        {/* Sidebar Stats */}
                        <div className="w-full md:w-72 bg-slate-900 border-r border-slate-800 p-6 flex flex-col justify-between z-10">
                            <div>
                                <h1 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-pink-400 mb-2 tracking-tighter">
                                    SAVANNA SQUAD
                                </h1>
                                <div className="flex gap-2 mb-6">
                                    <span className="text-[10px] font-bold bg-indigo-900/50 text-indigo-300 px-2 py-1 rounded border border-indigo-800">v19.0</span>
                                    <span className="text-[10px] font-bold bg-green-900/50 text-green-300 px-2 py-1 rounded border border-green-800">The Wildfire</span>
                                </div>
                                
                                <div className="bg-slate-800/50 p-4 rounded-2xl shadow-sm border border-slate-700 mb-4 backdrop-blur-sm relative overflow-hidden">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 flex items-center gap-1"><Icon path={ICONS.Star} size={12} /> Skills</h3>
                                    <StatBar label="Caring" value={stats.emp} icon={ICONS.Heart} colorClass="text-pink-400" barColorClass="bg-pink-500" statKey="emp" />
                                    <StatBar label="Professional" value={stats.prof} icon={ICONS.Shield} colorClass="text-indigo-400" barColorClass="bg-indigo-500" statKey="prof" />
                                    <StatBar label="Speaking Up" value={stats.assert} icon={ICONS.Zap} colorClass="text-amber-400" barColorClass="bg-amber-500" statKey="assert" />
                                    <StatBar label="Patient" value={stats.pat} icon={ICONS.Hourglass} colorClass="text-cyan-400" barColorClass="bg-cyan-500" statKey="pat" />
                                    <StatBar label="Calm" value={stats.reg} icon={ICONS.Activity} colorClass="text-emerald-400" barColorClass="bg-emerald-500" statKey="reg" />
                                    
                                    {Object.values(stats).some(v => v <= 2) && (
                                        <div className="absolute inset-x-0 bottom-0 bg-red-500/20 p-2 text-center text-red-300 text-[10px] font-bold animate-pulse">
                                            <Icon path={ICONS.AlertTriangle} size={10} className="inline mr-1"/> WARNING: LOW STATS
                                        </div>
                                    )}
                                </div>
                            </div>
                            <button onClick={resetGame} className="flex items-center justify-center gap-2 p-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold transition-all hover:scale-[1.02] border border-slate-700 text-sm">
                                <Icon path={ICONS.RefreshCw} size={16} /> Restart Shift
                            </button>
                        </div>

                        {/* Main Stage */}
                        <div className={`flex-1 relative flex flex-col bg-gradient-to-b ${scene?.bg || 'from-slate-900 to-black'} transition-colors duration-1000`}>
                            <div className="flex-1 flex items-end justify-center pb-0 mb-[-20px] px-4 relative overflow-hidden">
                                <div className="absolute inset-0 opacity-10 flex justify-between items-center px-10 pointer-events-none">
                                    <Icon path={ICONS.Shield} size={200} />
                                    <Icon path={ICONS.Heart} size={200} />
                                </div>
                                {currentSceneId === 'game_over' && (
                                    <div className="absolute inset-0 flex items-center justify-center z-10 animate-pop">
                                        <Icon path={ICONS.Skull} size={150} className="text-red-500 opacity-80" />
                                    </div>
                                )}
                                {currentSceneId === 'win_game' && (
                                    <div className="absolute inset-0 flex flex-col items-center justify-center z-10 animate-pop">
                                        <Icon path={ICONS.Award} size={120} className="text-yellow-400 drop-shadow-lg mb-4" />
                                        <div className="bg-white text-slate-900 p-6 rounded-lg shadow-2xl max-w-sm text-center border-4 border-yellow-400 transform rotate-1">
                                            <h2 className="text-2xl font-black mb-2 uppercase tracking-widest text-indigo-900">Certificate of Awesome</h2>
                                            <p className="text-sm font-bold mb-4">Awarded to Ayshe</p>
                                            <p className="text-xs italic">"For outstanding bravery, kindness, and smarts during the Grand Parade!"</p>
                                            <div className="mt-4 border-t-2 border-slate-900 w-32 mx-auto pt-1 font-handwriting">Capt. Bobby</div>
                                        </div>
                                    </div>
                                )}
                                {scene?.character && (
                                    <div className={`w-72 h-72 md:w-96 md:h-96 ${reduceMotion ? '' : 'animate-in slide-in-from-bottom-8 duration-500'}`}>
                                        <SavannaAvatar 
                                            type={scene.character} 
                                            prop={scene.text.includes("polishing") ? "clipboard" : 
                                                  scene.text.includes("medal") ? "medal" : 
                                                  currentSceneId.includes("16") ? "clipboard" :
                                                  currentSceneId.includes("17") ? "party_hat" : 
                                                  currentSceneId.includes("18") ? "flag" : 
                                                  currentSceneId.includes("21") ? "fire" : null}
                                        />
                                    </div>
                                )}
                            </div>

                            {/* Dialogue/Feedback Area */}
                            <div className="relative z-20 min-h-[320px]">
                                {feedback ? (
                                    <div className="absolute inset-0 bg-slate-900/95 backdrop-blur-xl border-t border-slate-700 p-8 flex flex-col items-center justify-center text-center animate-pop z-30">
                                        <div className="bg-indigo-900/30 p-4 rounded-full text-indigo-400 mb-4 border border-indigo-800">
                                            <Icon path={feedback.message.includes("LIFE EVENT") ? ICONS.Dice : ICONS.Brain} size={40} />
                                        </div>
                                        <h3 className="text-2xl font-bold text-white mb-2">{feedback.message.includes("LIFE EVENT") ? "Life Happens!" : "Review"}</h3>
                                        <p className="text-slate-300 text-lg mb-6 max-w-lg">{feedback.message}</p>
                                        <button onClick={handleFeedbackDismiss} className="px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-2xl transition-all shadow-lg hover:shadow-indigo-500/30 flex items-center gap-2">
                                            Continue (Press Space) <Icon path={ICONS.ArrowRight} />
                                        </button>
                                    </div>
                                ) : (
                                    <div className="h-full bg-slate-900/80 backdrop-blur-xl border-t border-slate-700 p-6 flex flex-col shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                                        {scene?.speaker && scene.speaker !== 'System' && (
                                            <div className="absolute -top-6 left-0 right-0 px-8 flex justify-between items-end">
                                                <div className="bg-gradient-to-r from-pink-600 to-indigo-600 text-white px-6 py-2 rounded-2xl font-bold shadow-lg text-sm tracking-wide border border-indigo-400/30">
                                                    {scene.speaker}
                                                </div>
                                                <button onClick={isSpeaking ? stop : readCurrentScene} className={`p-3 rounded-full shadow-lg transition-all transform hover:scale-105 ${isSpeaking ? 'bg-red-500 text-white animate-pulse' : 'bg-slate-800 text-indigo-400 border border-slate-600'}`} title="Read Aloud">
                                                    <Icon path={isSpeaking ? ICONS.StopCircle : ICONS.Volume2} size={24} />
                                                </button>
                                            </div>
                                        )}
                                        <p className="text-xl md:text-2xl text-slate-100 font-semibold leading-relaxed mt-4 mb-6">
                                            {typeof scene?.text === 'function' ? scene.text(flags) : (currentSceneId === 'win_game' ? winMessage : scene?.text)}
                                        </p>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-auto">
                                            {currentChoices.map((choice, idx) => (
                                                <button key={idx} onClick={() => handleChoice(choice)} className="text-left w-full p-4 bg-slate-800 border border-slate-700 hover:border-indigo-500 hover:bg-indigo-900/20 rounded-xl text-slate-200 font-bold transition-all hover:scale-[1.01] active:scale-95 flex items-center group shadow-sm relative overflow-hidden">
                                                    <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-indigo-500 to-pink-500 opacity-0 group-hover:opacity-100 transition-opacity" />
                                                    <span className="w-8 h-8 rounded-lg bg-slate-700 text-slate-400 flex items-center justify-center text-sm mr-3 group-hover:bg-indigo-600 group-hover:text-white transition-colors font-black flex-shrink-0">
                                                        {String.fromCharCode(49 + idx)}
                                                    </span>
                                                    <span className="text-sm">{choice.text}</span>
                                                </button>
                                            ))}
                                        </div>
                                        {(currentSceneId === 'win_game' || currentSceneId === 'game_over') && (
                                            <div className="mt-4 flex justify-center">
                                                <button onClick={handleShare} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-xl flex items-center gap-2 transition-all">
                                                    <Icon path={ICONS.Mail} size={18} /> Share Results
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SocialSimGameV10 />);
    </script>
</body>
</html>